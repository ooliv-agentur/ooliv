
# Enable URL rewriting
RewriteEngine On

# Redirect from www to non-www - MUST COME FIRST
RewriteCond %{HTTP_HOST} ^www\.ooliv\.de [NC]
RewriteRule ^(.*)$ https://ooliv.de/$1 [L,R=301]

# Force HTTPS (applies after domain is already correct)
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}/$1 [L,R=301]

# Redirect /de/ prefix to root paths
RewriteRule ^de/(.*)$ /$1 [R=301,L]
RewriteRule ^de/?$ / [R=301,L]

# Redirect ALL .php files to homepage
RewriteRule ^.*\.php$ / [R=301,L]

# Redirect old paths to new structure
RewriteRule ^author/(.*)$ /ueber-uns [R=301,L]
RewriteRule ^projekte/(.*)$ /referenzen [R=301,L]
RewriteRule ^projekte/?$ /referenzen [R=301,L]
RewriteRule ^leistungen/(.*)$ /webdesign [R=301,L]
RewriteRule ^leistungen/?$ /webdesign [R=301,L]
RewriteRule ^ooliv/(.*)$ /ueber-uns [R=301,L]
RewriteRule ^ooliv/?$ /ueber-uns [R=301,L]
RewriteRule ^ueber-ooliv/(.*)$ /ueber-uns [R=301,L]
RewriteRule ^ueber-ooliv/?$ /ueber-uns [R=301,L]
RewriteRule ^case-studies/(.*)$ /referenzen [R=301,L]
RewriteRule ^case-studies/?$ /referenzen [R=301,L]
RewriteRule ^werbeagentur-frankfurt/(.*)$ / [R=301,L]
RewriteRule ^werbeagentur-frankfurt/?$ / [R=301,L]
RewriteRule ^webdesign-agentur-wiesbaden/(.*)$ /werbeagentur-wiesbaden [R=301,L]
RewriteRule ^webdesign-agentur-wiesbaden/?$ /werbeagentur-wiesbaden [R=301,L]
RewriteRule ^webdesign-agentur-frankfurt/(.*)$ / [R=301,L]
RewriteRule ^webdesign-agentur-frankfurt/?$ / [R=301,L]
RewriteRule ^wordpress-agentur-wiesbaden/(.*)$ /werbeagentur-wiesbaden [R=301,L]
RewriteRule ^wordpress-agentur-wiesbaden/?$ /werbeagentur-wiesbaden [R=301,L]
RewriteRule ^wordpress-agentur-mainz/(.*)$ / [R=301,L]
RewriteRule ^wordpress-agentur-mainz/?$ / [R=301,L]
RewriteRule ^kunden/(.*)$ /referenzen [R=301,L]
RewriteRule ^kunden/?$ /referenzen [R=301,L]

# Remove trailing slashes from all URLs except root
RewriteCond %{REQUEST_URI} !^/$
RewriteCond %{REQUEST_URI} (.+)/$
RewriteRule ^(.*)$ /%1 [R=301,L]

# Add canonical header and other SEO headers
<IfModule mod_headers.c>
    # Exclude API routes and sitemap from canonical headers
    <LocationMatch "^/(api|sitemap\.xml)">
        Header unset Link
        Header unset Vary  
        Header unset X-Robots-Tag
    </LocationMatch>
    
    # Set proper canonical header (fixed typo - removed extra 's')
    Header set Link "<https://ooliv.de%{REQUEST_URI}>; rel=\"canonical\""
    
    # Help Google understand that responses vary based on host header
    Header set Vary "Host"
    
    # Ensure X-Robots-Tag is set to index, follow for all responses
    Header set X-Robots-Tag "index, follow"
    
    # Add explicit canonical header for www redirect scenario
    Header always set Link "<https://ooliv.de%{REQUEST_URI}>; rel=\"canonical\"" env=REDIRECT_STATUS
</IfModule>

# Improve server performance
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/css text/javascript application/javascript application/json
</IfModule>

# Set far-future expires headers for static assets
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
</IfModule>

# Handle pushState routing (SPA)
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/(api|sitemap\.xml)
RewriteRule ^ index.html [L,QSA]
